# Azure Deployment Plan for uportal-messaging-v2 Project

## **Goal**
Deploy the uportal-messaging-v2 Spring Boot microservice to Azure using Azure Developer CLI (AZD). The application will be containerized and hosted on Azure Container Apps.

## **Project Information**
**uportal-messaging-v2**  
- **Stack**: Spring Boot 3.5.0 with Java 17  
- **Type**: REST API microservice for managing messages (notifications and announcements)  
- **Containerization**: Dockerfile created (multi-stage build)  
- **Dependencies**: None (stateless application using JSON file for messages)  
- **Hosting**: Azure Container Apps (recommended for containerized microservices)

## **Azure Resources Architecture**
> **Install the Mermaid extension in your IDE to view the architecture diagram.**

```mermaid
graph TD
%% Services
svcazurecontainerapps_uportalmessaging["`Name: uportal-messaging
Path: 
Language: java
Port: 8080
DockerFile: Dockerfile
Docker Context: ./`"]
subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps (ACA) Environment"]
azurecontainerapps_uportalmessaging("`uportal-messaging (Azure Container App)`")
end
containerappenv:::cluster
end
%% Supporting Services
azurecontainerregistry["Azure Container Registry (ACR)"]
azureloganalytics["Log Analytics Workspace"]
azureappinsights["Application Insights"]
azuremanagedidentity["User-Assigned Managed Identity"]

%% Relationships
svcazurecontainerapps_uportalmessaging --> |"hosted on"| azurecontainerapps_uportalmessaging
azurecontainerapps_uportalmessaging --> |"pulls images from"| azurecontainerregistry
azurecontainerapps_uportalmessaging --> |"uses identity"| azuremanagedidentity
azurecontainerapps_uportalmessaging --> |"sends logs to"| azureloganalytics
azurecontainerapps_uportalmessaging --> |"sends telemetry to"| azureappinsights
azuremanagedidentity --> |"has AcrPull role on"| azurecontainerregistry
```

### Architecture Description:
- The **Azure Container App** hosts the containerized Spring Boot application
- The container image is stored and pulled from **Azure Container Registry**
- **User-Assigned Managed Identity** provides secure access to ACR without storing credentials
- **Log Analytics Workspace** collects logs from the Container App for monitoring and debugging
- **Application Insights** tracks application telemetry, performance metrics, and request traces

## **Recommended Azure Resources**

### Application: uportal-messaging
- **Hosting Service Type**: Azure Container Apps
- **SKU**: Consumption-based (0.5 vCPU, 1.0 GB memory per replica)
  - Scales to zero when not in use
  - Auto-scales based on HTTP traffic
  - Suitable for microservices with variable load
- **Configuration**:
  - Language: Java 17
  - Port: 8080
  - Environment Variables: 
    - `message.source=classpath:messages.json` (default, already configured)
  - Dockerfile Path: `Dockerfile`
  - Docker Context: `.`
  - Minimum Replicas: 0
  - Maximum Replicas: 10
- **Dependencies**: None (stateless application)

## **Recommended Supporting Services**

### Application Insights
- **Purpose**: Application performance monitoring and telemetry
- **Configuration**: Automatically connected to the Container App

### User-Assigned Managed Identity
- **Purpose**: Secure authentication to Azure Container Registry
- **Permissions**: AcrPull role on the Container Registry

### Log Analytics Workspace
- **Purpose**: Centralized logging and diagnostics
- **Configuration**: Container App environment logs sent here

### Azure Container Registry
- **SKU**: Basic (suitable for development and testing)
  - Performance: Up to 100 GB storage, sufficient throughput for single microservice
- **Purpose**: Store and manage Docker container images

## **Recommended Security Configurations**
- **User-Assigned Managed Identity**: Must have AcrPull role (`7f951dda-4ed3-4680-a7ca-43fe172d538d`) assigned to the Container Registry
- **Container App**: Must be assigned the User-Assigned Managed Identity
- **Network Security**: Container App uses HTTPS endpoints by default
- **Image Security**: Container runs as non-root user (defined in Dockerfile)

## **Execution Steps**
> **Follow these steps in order. Update `.azure/progress.copilotmd` after each step.**

### 1. Create Azure Infrastructure Files for AZD
   - [x] Provisioning tool: AZD
   - [ ] Expected files: `azure.yaml`, `infra/main.bicep`, `infra/main.parameters.json`
   - [ ] Get current subscription ID
   - [ ] Call `appmod-get-available-region-sku` to get available regions and SKUs for:
     - Microsoft.App/containerApps
     - Microsoft.ContainerRegistry/registries
     - Microsoft.OperationalInsights/workspaces
     - Microsoft.Insights/components
   - [ ] Generate missing files using `appmod-get-iac-rules` for Bicep generation rules
   - [ ] Validate generated Bicep files (no syntax errors)

### 2. Environment Setup for AZD
   - [ ] Install AZ CLI (if not already installed)
   - [ ] Install AZD (if not already installed)
   - [ ] Run `azd auth login` to authenticate
   - [ ] Run `azd env new <envName> --no-prompt` to create a new environment
   - [ ] Set required environment variables:
     - `AZURE_SUBSCRIPTION_ID`: (use default subscription from AZ CLI)
     - `AZURE_LOCATION`: (from available regions check)
     - `AZURE_RESOURCE_GROUP`: (create new resource group)
   - [ ] Create resource group with `az group create`

### 3. Containerization
   - [x] Dockerfile exists at: `Dockerfile`
   - [x] Docker build context: Current directory (`.`)
   - [x] Multi-stage build configured (build stage + runtime stage)

### 4. Deployment
   - [ ] Run `azd provision --preview --no-prompt` to preview infrastructure
   - [ ] Run `azd up --no-prompt` to deploy application
   - [ ] Monitor deployment progress
   - [ ] Handle any deployment errors (iterate and retry)

### 5. Deployment Validation
   - [ ] Use `appmod-get-azd-app-logs` to check application logs
   - [ ] Verify the application is running and accessible
   - [ ] Test API endpoints:
     - GET `/` (health check)
     - GET `/messages` (list messages)
     - GET `/admin/allMessages` (admin endpoint)

### 6. Summarize Deployment Result
   - [ ] Use `appmod-summarize-result` tool to generate deployment summary
   - [ ] Generate file: `.azure/summary.copilotmd`

## **Progress Tracking**
Progress will be tracked in `.azure/progress.copilotmd` with the following format:
- ‚úÖ Completed tasks
- üî≤ Pending tasks
- ‚ùå Failed tasks with error notes

Any failed steps will be logged with error details, fixed, and retried until successful.
